{% extends 'default.html' %}

{% block title %}Web Tools{% endblock %}

{% block content %}
<style>
    
  #targetUrl {
    background-color: #323840; 
    color: #fff; 
    border: 1px solid #6c757d; 
    margin-bottom: 1rem; 
  }
  .container {
    height: 75vh;
  }

  
  .btn-primary {
    background-color: #495057; 
    border-color: #495057; 
  }

  /* Add hover effect for the primary button */
  .btn-primary:hover {
    background-color: #5e6770;
    border-color: #5e6770;
  }

  /* Style the secondary button */
  .btn-secondary {
    background-color: #6c757d; 
    border-color: #6c757d; 
  }

  /* Add hover effect for the secondary button */
  .btn-secondary:hover {
    background-color: #7a8288;
    border-color: #7a8288;
  }
</style>
<div class="container d-flex justify-content-center align-items-center">
    <div class="row justify-content-center">
      <input type="text" id="targetUrl" class="form-control" placeholder="Enter target URL">
      <!--buttons to start scans functions-->
      <button onclick="startSpider()" class="btn btn-primary">Start Spider Scan</button>
      <button onclick="startActiveScan()" class="btn btn-secondary">Start Active Scan</button>
    </div>
  </div>
  
    <pre id="output"></pre>

    <!--SCRIPT for when sending requests to the backend zap api -->
    <script>
      function startScan(apiEndpoint) {
          var targetUrl = document.getElementById('targetUrl').value;
          if (!targetUrl) {
              document.getElementById('output').textContent = 'Please enter a URL.';
              return;
          }
    
          document.getElementById('output').textContent = 'Starting scan...';
    
          fetch(apiEndpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: targetUrl })
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Network response was not ok: ' + response.statusText);
              }
              return response.json();
          })
          .then(data => {
              if (data.error) {
                  document.getElementById('output').textContent = 'Error: ' + data.error;
              } else {
                  document.getElementById('output').textContent = JSON.stringify(data, null, 2);
                  if (data.scan_id) {
                      trackScanProgress(apiEndpoint, data.scan_id);
                  }
              }
          })
          .catch(error => {
              console.error('Error:', error);
              document.getElementById('output').textContent = 'Error: ' + error.message;
          });
      }
      
      function trackScanProgress(apiEndpoint, scanId) {
          const statusEndpoint = `${apiEndpoint}/${scanId}/status`; 
          setTimeout(function() {
              fetch(statusEndpoint)
              .then(response => response.json())
              .then(data => {
                  if (data.status === 'completed') {
                      document.getElementById('output').textContent += "\nScan completed. Results: " + JSON.stringify(data.results, null, 2);
                  } else {
                      document.getElementById('output').textContent += "\nScan status: " + data.status;
                      trackScanProgress(apiEndpoint, scanId); // Recursively check status
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  document.getElementById('output').textContent += '\nError checking scan progress: ' + error.message;
              });
          }, 5000); // Check every 10 seconds
      }
      
      function startSpider() {
          startScan('/start_spider');
      }
      
      function startActiveScan() {
          startScan('/start_active_scan');
      }
    </script>
{% endblock %}